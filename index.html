<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>武将一覧</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>武将一覧</h1>

<!-- 検索 -->
<input
  type="text"
  id="search"
  placeholder="武将名で検索"
  style="width:100%; padding:10px; font-size:16px; margin-bottom:8px;"
>

<!-- 武力フィルタ -->
<input
  type="number"
  id="minPower"
  placeholder="武力 下限"
  style="width:100%; padding:10px; font-size:16px; margin-bottom:12px;"
>

<ul id="list"></ul>

<script>
let data = [];

// URLパラメータ取得（詳細表示用）
const params = new URLSearchParams(location.search);
const selectedId = params.get('id');

// CSV読み込み
fetch('data/busho.csv?ver=' + Date.now())
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split('\n').slice(1);
    data = rows.map(row => {
      const [id, name, power] = row.split(',');
      return {
        id,
        name,
        power: Number(power)
      };
    });

    if (selectedId) {
      showDetail(selectedId);
    } else {
      render(data);
    }
  });

// 一覧表示
function render(listData) {
  const list = document.getElementById('list');
  list.innerHTML = '';

  listData.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `
      <a href="?id=${item.id}" style="text-decoration:none; color:inherit;">
        ${item.name}（武力 ${item.power}）
      </a>
    `;
    list.appendChild(li);
  });
}

// 検索・フィルタ適用
function applyFilter() {
  const keyword = document.getElementById('search').value;
  const minPower = Number(document.getElementById('minPower').value || 0);

  const filtered = data.filter(item =>
    item.name.includes(keyword) &&
    item.power >= minPower
  );

  render(filtered);
}

// イベント登録
document.getElementById('search').addEventListener('input', applyFilter);
document.getElementById('minPower').addEventListener('input', applyFilter);

// 詳細表示
function showDetail(id) {
  const item = data.find(d => d.id === id);
  if (!item) return;

  document.body.innerHTML = `
    <h1>${item.name}</h1>

    <div class="container">
      <div class="card">
        <canvas id="statusChart" width="280" height="280"></canvas>
        <p style="font-size:12px; color:#666; margin-top:8px;">
          <span style="color:#4caf50;">■</span> Lv50　
          <span style="color:#2196f3;">■</span> Lv1
        </p>
      </div>
    </div>

    <a class="back" href="index.html">← 一覧に戻る</a>
  `;

  // 仮データ（後でCSV正式化）
  const statsLv1 = {
    武力: item.power - 20,
    知力: item.power - 25,
    統率: item.power - 22,
    速度: item.power - 18,
    防御: item.power - 20,
    攻撃: item.power - 15
  };

  const statsLv50 = {
    武力: item.power,
    知力: item.power,
    統率: item.power,
    速度: item.power,
    防御: item.power,
    攻撃: item.power
  };

  drawRadarChartMulti(
    'statusChart',
    [statsLv50, statsLv1],
    [
      'rgba(76,175,80,0.45)',   // Lv50
      'rgba(33,150,243,0.35)'   // Lv1
    ],
    100
  );
}

function drawRadarChartMulti(canvasId, statsList, colors, maxValue) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');

  const labels = Object.keys(statsList[0]);
  const count = labels.length;

  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = 100;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ガイド
  ctx.strokeStyle = '#ccc';
  for (let level = 1; level <= 5; level++) {
    ctx.beginPath();
    labels.forEach((_, i) => {
      const angle = (Math.PI * 2 / count) * i - Math.PI / 2;
      const r = radius * (level / 5);
      const x = centerX + r * Math.cos(angle);
      const y = centerY + r * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.stroke();
  }

  // 軸＋ラベル
  labels.forEach((label, i) => {
    const angle = (Math.PI * 2 / count) * i - Math.PI / 2;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(x, y);
    ctx.stroke();

    ctx.fillStyle = '#333';
    ctx.font = '12px sans-serif';
    ctx.fillText(label, x - 10, y - 4);
  });

  // ステータスを重ね描き
  statsList.forEach((stats, idx) => {
    const values = Object.values(stats);

    ctx.beginPath();
    values.forEach((value, i) => {
      const angle = (Math.PI * 2 / count) * i - Math.PI / 2;
      const r = radius * (value / maxValue);
      const x = centerX + r * Math.cos(angle);
      const y = centerY + r * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.closePath();

    ctx.fillStyle = colors[idx];
    ctx.strokeStyle = colors[idx].replace('0.', '1.');
    ctx.fill();
    ctx.stroke();
  });
}


</script>

</body>
</html>
